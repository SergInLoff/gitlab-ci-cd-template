## Версия V1.0
### Общее описание алгоритма работы

Данная версия работает на сопоставлении имен веток. Для каждого сервиса, находящегося в репозитории, необходимо задать префикс, который будет присутствовать в названии ветки разработки и конечной ветки (`stable`). При работе с репозиторием при совершении комитов, создании merge-request или же при слиянии веток, происходит создание pipline-ов с различным набором джобов. Основное описание реакции Gitlab при совершении действий с ветками описан ниже.

### Последовательность сообщений в репозитории проекта

```plantuml

skinparam roundcorner 20

programmer -> feature_branch: push commit
feature_branch -> feature_branch: build,\n linting,\n test
feature_branch -> stable_feature_branch: open MR
stable_feature_branch -> stable_feature_branch: delivery,\n deploy to dev environment,\n deploy to test environments
stable_feature_branch -> stable_feature_branch: accept MR
stable_feature_branch -> stable_feature_branch: auto deploy to production,\n auto deploy to all test environments

```

Для каждого сервиса необходимо определить как минимум две ветки:
- ветка разработки
- stable ветка,- конечная ветка, в которую происходит MR

При необходимости, stable ветку можно сливать в ветку `master`, но никаких действий и pipline не будет сформировано.

### Внимание!

При слиянии ветки разработки и `stable` ветки, происходит автоматический делой в продуктовую среду, а после версия приложени раскатывается на все тестовые среды.

Версия приложения автоматически определяется из версии проекта `.csproj`. Так что для выпуска новых версий образов, необходимо повышать версию сборок! Поэтому теги образов определяются автоматически. У тех проектов, у которых версия не указана, применяется версия по умолчанию 1.0.0.

### Настройка данной версии CI/CD

Для работы данной версии, необходимо:
1. Скопировать файл `env.local` из каталога `lib/service/v1.0/` для каждого сервиса.    
2. Заполнить заданные параметры в файле `env.local`
3. Определить префиксы всех сервисов, которые будут собираться в CI/CD. Например `service_a`.
4. Скопировать файл `lib/service/.stable.v1.0.gitlab-ci.yml` в корень дериктории репозитория.
5. Прописать скопированный файл в настройках репозитория `Settings->CI/CD->General pipelines->Custom CI configuration path`
6. В скопированном файле в разделе `before_script` прописать задание маршрута до файла `env.local` для каждого определенного префикса:
   ```
   - if [[ "$CI_COMMIT_REF_NAME" =~ ^([0-9]+)-test-app-* ]] || [[ "$CI_COMMIT_REF_NAME" =~ ^stable-test-app-* ]]; then
        ENV_PARAMS_FILE="lib/service/env.local";
      else 
        echo "Parameters for this condition isn't defined."
        exit 1;
      fi;
   ```

#### Пояснение!
В приведенном выше примере `^([0-9]+)-test-app-*` и `^stable-test-app-*` - регулярные выражения, позволяющие определить из названия веток, для какого сервиса взять файл настроек, чтобы сформировать необходимый pipline.

На основании выше приведенных регулярных выражений, ниже представлены возможные наименования веток:
Для `^([0-9]+)-test-app-*`:
`27453-test-app-add-new-feature`
`23593-test-app-add-fix-reload_data`
, где в первой позиции `27453` номер задачи из Bitrix, на основании которой реализуется фича
`test-app` - префикс сервиса
`add-new-feature` - описание того, что реализуется в ветке

Для `^stable-test-app-*`:
`stable` - признак конечной ветки, в которой содержится актуальный код сервиса, который задеплоен в продуктовую среду.
`test-app` - префикс сервиса, который содержится в конечной ветке.
   
